name: Release binaries
# This machine tests building the software on a both 32 and 64 Windows architecture.

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:

  version:
    name: Extract version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Extract version from tag
        id: extract
        run: |
          if [ -n "${{ github.ref_name }}" ]; then
            # Remove 'v' prefix if present
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            # Fallback to VERSION file
            VERSION=$(cat VERSION | jq -r '"\(.major).\(.minor).\(.patch)"')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  source:
    name: Build source release
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Make source release
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -e -o pipefail
          set -x
                  
          mkdir -p artifact/yubihsm-connector
          tar --exclude .git --exclude .github --exclude artifact --transform="s/^\./yubihsm-connector-$VERSION/" -czf ../yubihsm-connector-$VERSION.tar.gz .
          pwd
          ls ..
          cp ../yubihsm-connector-$VERSION.tar.gz artifact/yubihsm-connector

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yubihsm-connector-src
          path: artifact

  Windowsx-build:
    name: Build Windows release binaries
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and make MSI installer
        run: |
          $ErrorActionPreference = "Stop"
          Set-PSDebug -Trace 1
          mkdir artifact

          choco install -y golang 
          
          go mod tidy
          go generate ./...
          go build -o bin/yubihsm-connector.exe
          cp bin/yubihsm-connector.exe artifact\
          
          ./bin/yubihsm-connector.exe version
          ./bin/yubihsm-connector.exe --help
          
          cd resources/win-installer
          & cmd /c '"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsMSBuildCmd.bat" && msbuild YubiHSMConnectorInstaller.sln /p:Configuration=Release'
          cp x64/Release/yubihsm-connector-windows-amd64.msi ../../artifact/          

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yubihsm-connector-windows-amd64
          path: artifact

  macos-build:
    name: Build MacOS release binaries
    runs-on: ${{ matrix.os }}
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest-large
            arch: amd
          - os: macos-latest-xlarge
            arch: arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and make MSI installer
        run: |
          set -e -o pipefail
          set -x
          mkdir artifact
          
          brew install golang
                                       
          make GB_BUILD_FLAGS="-tags disable_seccomp -ldflags '-s'"
          strip -u -r bin/yubihsm-connector*
          cp bin/yubihsm-connector artifact

          ./bin/yubihsm-connector version
          ./bin/yubihsm-connector --help          

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yubihsm-connector-mac-${{ matrix.arch }}64
          path: artifact

  linux-binaries:
    name: Build Linux binaries
    runs-on: ubuntu-latest
    needs: version
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.17'

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libusb-1.0-0-dev

      - name: Build binary
        env:
          VERSION: ${{ needs.version.outputs.version }}
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 1
        run: |
          set -e -o pipefail
          set -x
          
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export CC=aarch64-linux-gnu-gcc
          fi
          
          go mod tidy
          go generate ./...
          go build -o bin/yubihsm-connector
          strip --strip-all bin/yubihsm-connector

      - name: Package release
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          set -e -o pipefail
          set -x
          
          mkdir -p artifact/yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}
          
          # Copy binary
          cp bin/yubihsm-connector artifact/yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}/
          
          # Copy config file
          cp deb/yubihsm-connector.yaml artifact/yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}/yubihsm-connector.yaml.example
          
          # Copy udev rules
          mkdir -p artifact/yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}/udev
          cp deb/70-yubihsm-connector.rules artifact/yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}/udev/
          
          # Create tarball
          cd artifact
          tar -czf yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}.tar.gz yubihsm-connector-${VERSION}-linux-${{ matrix.arch }}
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: yubihsm-connector-linux-${{ matrix.arch }}
          path: artifact/yubihsm-connector-${{ needs.version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz

  debian_based:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        environment: [
          "ubuntu:25.04",
          "ubuntu:24.04",
          "ubuntu:22.04",
          "debian:12",
          "debian:13",
        ]

    name: build on ${{ matrix.environment }}
    runs-on: ubuntu-latest
    container: ${{ matrix.environment }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: extract platform name
        env:
          DOCKER_IMAGE: ${{ matrix.environment }}
        run: |
          # Remove everything from DOCKER_IMAGE that is not a letter or a number
          PLATFORM=$(echo -n "$DOCKER_IMAGE" | sed -E 's/[^a-zA-Z0-9]//g')
          echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

      - name: install dependencies from package management
        env:
          CC: ${{ matrix.cc }}
          DEBIAN_FRONTEND: noninteractive
        run: |
          export DEBIAN_FRONTEND=noninteractive

          apt-get update && apt-get dist-upgrade -y
          apt-get install -y build-essential libusb-1.0.0-dev pkg-config chrpath git curl
          
          echo "PLATFORM = $PLATFORM"
          
          if [ $PLATFORM = "ubuntu1804" ] || [ "$PLATFORM" = "ubuntu1604" ] || [ $PLATFORM = "ubuntu1404" ] || [ $PLATFORM = "debian10" ]; then
            curl -L --max-redirs 2 -o - https://golang.org/dl/go1.13.8.linux-amd64.tar.gz |\
              tar -C /usr/local -xzvf -
          else
            apt-get install -y golang
          fi
                    
          curl -L -o go-bin-deb.dpkg https://github.com/mh-cbon/go-bin-deb/releases/download/0.0.19/go-bin-deb-amd64.deb
          dpkg -i go-bin-deb.dpkg
          apt-get install --fix-missing

      - name: build release
        env:
          PLATFORM: ${{ env.PLATFORM }}
        run: |
          set -x

          # Create directory containing all output
          OUTPUT=$GITHUB_WORKSPACE/$PLATFORM/yubihsm-connector
          mkdir -p $OUTPUT

          export PATH=$PATH:/usr/local/go/bin

          make
          strip --strip-all bin/yubihsm-connector
          version=`bin/yubihsm-connector version`
          go-bin-deb generate -f deb/deb.json -a amd64 --version=${version}-1
          cp *.deb $OUTPUT/

          LICESE_DIR="$OUTPUT/share/yubihsm-connector"
          mkdir -p $LICESE_DIR
          cp -r $GITHUB_WORKSPACE/resources/release/licenses $LICESE_DIR/
          for lf in $LICESE_DIR/licenses/*; do
            chmod 644 $lf
          done

          cd $OUTPUT
          rm -f yubihsm-connector-$PLATFORM-amd64.tar.gz
          tar -C .. -zcvf ../yubihsm-connector-$PLATFORM-amd64.tar.gz yubihsm-connector

      - name: install binaries
        working-directory: ${{ github.workspace }}/${{ env.PLATFORM }}/yubihsm-connector
        run: |
          set -x
          dpkg -i ./yubihsm-connector_*.deb

      - name: cleanup build directory
        working-directory: ${{ github.workspace }}/${{ env.PLATFORM }}/yubihsm-connector
        run: |
          set -x
          rm -f *.deb
          rm -rf licenses
          rm -rf ../yubihsm-connector

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "yubihsm-connector-${{ env.PLATFORM }}-amd64"
          path: ${{ env.PLATFORM }}

  redhat_based:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        environment: [
          "fedora:41",
          "fedora:42",
        ]
        cc: [ "gcc" ]

    name: build on ${{ matrix.environment }}
    runs-on: ubuntu-latest
    container: ${{ matrix.environment }}

    steps:

      - name: checkout repository
        uses: actions/checkout@v4

      - name: extract platform name
        env:
          DOCKER_IMAGE: ${{ matrix.environment }}
        run: |
          # Remove everything from DOCKER_IMAGE that is not a letter or a number
          PLATFORM=$(echo -n "$DOCKER_IMAGE" | sed -E 's/[^a-zA-Z0-9]//g')
          echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

      - name: install dependencies
        env:
          PLATFORM: ${{ env.PLATFORM }}
        run: |
          dnf -y update
          dnf -y install gcc binutils git make libusb1-devel rpmdevtools golang

      - name: build release binaries
        env:
          PLATFORM: ${{ env.PLATFORM }}
        run: |
          export PATH=$PATH:/usr/local/go/bin:/opt/rh/devtoolset-7/root/usr/bin
               
          export INPUT=$GITHUB_WORKSPACE
          export OUTPUT=$GITHUB_WORKSPACE/$PLATFORM/yubihsm-connector
          rm -rf $OUTPUT
          mkdir -p $OUTPUT
          
          mkdir -p $GITHUB_WORKSPACE/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          echo '%_topdir %(echo $HOME)/rpmbuild' > $GITHUB_WORKSPACE/.rpmmacros
          
          RPM_DIR=$GITHUB_WORKSPACE/rpmbuild
          
          cp resources/release/yubihsm-connector.spec $RPM_DIR/SPECS/
          
          rpmbuild -bb $RPM_DIR/SPECS/yubihsm-connector.spec          
          cp /github/home/rpmbuild/RPMS/x86_64/*.rpm $OUTPUT/

          LICENSE_DIR="$OUTPUT/share/yubihsm-connector"
          mkdir -p $LICENSE_DIR
          cp -r $INPUT/resources/release/licenses $LICENSE_DIR/
          for lf in $LICENSE_DIR/licenses/*; do
            chmod 644 $lf
          done
          
          cd $OUTPUT
          rm -f "yubihsm-connector-$PLATFORM-amd64.tar.gz"
          tar -C ".." -zcvf "../yubihsm-connector-$PLATFORM-amd64.tar.gz" "yubihsm-connector"
          rm -f *.rpm
          rm -rf licenses
          rm -rf ../yubihsm-connector

      - name: install binaries
        working-directory: /github/home/rpmbuild/RPMS/x86_64
        run: |
          yum install -y ./yubihsm-connector-*.rpm

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "yubihsm-connector-${{ env.PLATFORM }}-amd64"
          path: ${{ env.PLATFORM }}

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [version, source, Windowsx-build, macos-build, linux-binaries, debian_based, redhat_based]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ needs.version.outputs.version }}
          files: |
            release-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
